# Automatic Database Backup
We set up cron jobs on remote instances to back up postgres database periodically.
To check existing cron jobs, run `crontab -l`.
To edit cron jobs, including adding new ones, run `crontab -e`.
The command to execute postgres database back, as listed below, should be put on the instance where the postgres container is running. On staging, it is a single instance that runs all docker containers, so there's no confusion. On production, always check which node runs postgres and it is usually the vGPU instance.
```
0 0,12 * * * docker exec $(docker ps -q -f name=postgres) backup
```
The backup files are stored in the docker volume with name "backup" but on production, this docker volume is actually kept on the data instance and shared with other instances. To access this docker volume, you should go to the data instance for production. If the setting in `production.sample` is used, then it is under the directory `/var/lib/docker/volumes/rodan_pg_backup/_data`.
However, since we have many users and projects, a single backup file is around 1.3GB in size. This means we need to clean up old backup files to free up space on both staging and production. It is probably a good practice to check and do this twice a year, at least.

To do this, we follow a simple rule that we keep less frequent backups for older files.
Currently we use this [script](scripts/backup_clean.sh) that keeps only one backup file per month for 2023.
This script is generated by ChatGPT so modify and use with caution if needed.

# Backing Up and Restoring the Database

While no cronjob for this exists at the time of writing, it is possible to backup from and restore to the postgres database in Rodan using scripts. For the following, assume the postgres container has ID `612b4ae59567`.

**Create a Backup**

This stores a backup with the name `backup_YYYY_MM_DDTHH_MM_SS.sql.gz`.
```bash
docker exec -it 612b4ae59567 backup
```

**See a list of Backups**
```bash
docker exec -it 612b4ae59567 backups
```

**Restore a Backup**

For a backup with the name `backup_YYYY_MM_DDTHH_MM_SS.sql.gz`,
```bash
docker exec -it 612b4ae59567 restore backup_YYYY_MM_DDTHH_MM_SS.sql.gz
```

On staging, these backups will persist in a separate volume so they are not tied to a specific postgres container.


### As of 2025, we are unsure if the SSL setting described below is still relevant.
# Renewing SSL Certificate

To renew the SSL certificate on Rodan instances, run `docker -ps` to get the nginx container id. Then run
```bash
docker exec -it [nginx_container_id] bash
```
to enter the container. Once in the container, run `certbot renew` to renew the certificate.

Finally, run `service nginx restart` within the container to update the changes. If these steps went smoothly, then the certificate should be renewed.

***

#### Todo

- Route all error messages to `Sentry.io`, and automatically triage them to workers in the lab.
- Create proper users/groups for the production container. In production (and on linux machines) docker needs to run as a privileged user. The container **<u>is not</u>** to be regarded as a layer of security. A root user inside the container can have root level effects outside of the container on linux. That is why a dummy user `www-data` is created in the `rodan`, `celery` containers.
  - The rodan container should be ran by the `django` or `rodan` user.
  - The nginx container should be ran by the `nginx` user.
  - The postgres container should be ran by the `postgres` user.
- Fix issues outlined by `https://github.com/docker/docker-bench-security`, and intergrate them with a `travis-ci` check.
- Deploy with docker swarm
- Create `celery-GPU` queue for GPU intensive workloads.

#### Permissions

- If you need root privileges inside of the docker container, you can specify a user with the `-u` before entering the container with `exec` or `run`.
  - `docker compose -f docker-compose.yml -u root rodan bash`
